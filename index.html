<!doctype html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SPR ‚Ä¢ Realocamento de Pacotes</title>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Google Identity Services (OAuth popup) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      /* Paleta Shopee ‚Äì tema claro */
      --primary:#ff5722; 
      --primary-2:#e14d1f;
      --bg:#f6f7fb; 
      --bg-elevated:#ffffff;
      --bg-soft:#fdf6f3;
      --card:#ffffff; 
      --txt:#111827; 
      --muted:#6b7280;
      --ok:#16a34a; 
      --err:#dc2626; 
      --chip:#fff0ea; 
      --line:#e4e4f0;
      --overlay: rgba(0,0,0,.52);
      --shadow-sm: 0 10px 30px rgba(15,23,42,.08);
      --shadow-md: 0 30px 60px rgba(15,23,42,.16);
      --radius-2xl:18px; 
      --radius-xl:16px; 
      --radius-lg:14px; 
      --radius:12px;

      --glass-bg: rgba(255,255,255,0.78);
      --glass-border: rgba(255,255,255,0.76);
      --glass-blur: 16px;
    }

    /* ===== TEMA ESCURO (classe no body) ===== */
    body.theme-dark{
      --bg:#050816;
      --bg-elevated:#070b16;
      --bg-soft:#0b1020;
      --card:rgba(15,23,42,0.92);
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --chip:rgba(251,146,60,0.14);
      --line:rgba(148,163,184,0.35);
      --shadow-sm:0 20px 45px rgba(0,0,0,.75);
      --shadow-md:0 40px 80px rgba(0,0,0,.9);
      --glass-bg:rgba(15,23,42,0.88);
      --glass-border:rgba(148,163,184,0.55);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      background:
        radial-gradient(1200px 520px at 12% -10%, rgba(255,148,114,0.65) 0%, transparent 55%),
        radial-gradient(900px 380px at 90% -6%, rgba(255,210,188,0.75) 0%, transparent 60%),
        var(--bg);
      color:var(--txt);
      font:500 15px/1.42 "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      -webkit-font-smoothing:antialiased; 
      -moz-osx-font-smoothing:grayscale;
      display:flex;flex-direction:column;min-height:100vh;
      transition:background 0.45s ease, color 0.35s ease;
    }

    body.theme-dark{
      background:
        radial-gradient(1400px 600px at -5% -10%, rgba(248,113,113,0.20) 0%, transparent 60%),
        radial-gradient(1200px 520px at 110% -10%, rgba(251,146,60,0.26) 0%, transparent 65%),
        radial-gradient(1200px 900px at 50% 120%, rgba(59,130,246,0.35) 0%, transparent 72%),
        var(--bg);
    }

    /* Cabe√ßalho compacto + glass */
    .appbar{
      position:sticky;top:0;z-index:30;
      background:linear-gradient(to bottom, rgba(255,255,255,0.86), rgba(255,255,255,0.72));
      backdrop-filter:saturate(1.3) blur(18px);
      border-bottom:1px solid rgba(226,232,240,0.8);
      box-shadow:0 14px 30px rgba(15,23,42,0.08);
      transition:background 0.35s ease, border-color 0.35s ease, box-shadow 0.35s ease;
    }
    body.theme-dark .appbar{
      background:linear-gradient(to bottom, rgba(15,23,42,0.96), rgba(15,23,42,0.86));
      border-bottom:1px solid rgba(30,64,175,0.55);
      box-shadow:0 22px 60px rgba(0,0,0,0.8);
    }

    .appbar-inner{
      max-width:1320px;margin:0 auto;
      padding:10px 18px;
      display:flex;gap:18px;align-items:center;justify-content:space-between;
    }

    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{
      width:32px;height:32px;border-radius:12px;
      background:
        radial-gradient(circle at 30% 30%, #fff7ed 0, transparent 62%),
        linear-gradient(135deg,#ff7b4d 0%,#ff5722 52%,#f97316 100%);
      box-shadow:
        0 0 0 2px rgba(255,255,255,0.8),
        0 10px 26px rgba(249,115,22,0.70);
      position:relative;
      overflow:hidden;
    }
    .brand .logo::after{
      content:"";
      position:absolute;inset:0;
      background:radial-gradient(circle at -10% -10%, rgba(255,255,255,0.85) 0, transparent 42%);
      opacity:.9;mix-blend-mode:screen;
    }
    body.theme-dark .brand .logo{
      box-shadow:
        0 0 0 2px rgba(15,23,42,0.9),
        0 0 25px rgba(249,115,22,0.9),
        0 0 60px rgba(251,191,36,0.35);
    }

    .brand-text h1{
      font-size:17px;
      letter-spacing:.25px;
      font-weight:800;
      display:flex;
      align-items:baseline;
      gap:6px;
      text-shadow:0 1px 0 rgba(255,255,255,0.7);
    }
    .brand-text h1 b{color:var(--primary)}
    body.theme-dark .brand-text h1{
      text-shadow:0 0 0 transparent;
    }
    .brand-sub{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      letter-spacing:.18px;
      margin-top:1px;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* ===== BOT√ÉO REALOCAMENTO INTELIGENTE / TEMA ===== */
    .theme-toggle{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid rgba(226,232,240,0.9);
      background:linear-gradient(135deg, rgba(255,255,255,0.96), rgba(248,250,252,0.96));
      box-shadow:0 10px 25px rgba(15,23,42,0.10);
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.18px;
      color:#0f172a;
      transition:
        background 0.35s ease,
        border-color 0.35s ease,
        box-shadow 0.35s ease,
        transform 0.15s ease;
      overflow:hidden;
    }
    .theme-toggle:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(15,23,42,0.18);
    }
    .theme-toggle:active{
      transform:scale(.985);
    }

    body.theme-dark .theme-toggle{
      background:radial-gradient(circle at 20% 0%, rgba(248,250,252,0.12) 0, transparent 55%),
                  linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border-color:rgba(59,130,246,0.65);
      color:#e5e7eb;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 20px 60px rgba(0,0,0,1);
    }

    .theme-toggle::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0% 0%, rgba(251,146,60,0.18) 0, transparent 46%);
      opacity:0;
      pointer-events:none;
      transition:opacity .35s ease;
    }
    body.theme-dark .theme-toggle::before{
      opacity:1;
    }

    .theme-toggle-bulb{
      position:relative;
      width:26px;height:26px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 18%, #fff7ed 0, #fed7aa 24%, #f97316 100%);
      box-shadow:
        0 0 0 2px rgba(254,243,199,0.9),
        0 0 18px rgba(251,191,36,0.95),
        0 0 32px rgba(250,204,21,0.85);
      display:flex;align-items:center;justify-content:center;
      transform-origin:center bottom;
      transition:
        background 0.35s ease,
        box-shadow 0.35s ease,
        transform 0.25s ease;
    }
    .theme-toggle-bulb span{
      font-size:15px;
    }

    body.theme-dark .theme-toggle-bulb{
      background:radial-gradient(circle at 30% 18%, #020617 0, #020617 70%, #0b1120 100%);
      box-shadow:
        0 0 0 1px rgba(30,64,175,0.7),
        0 0 12px rgba(59,130,246,0.75),
        0 0 30px rgba(15,23,42,1);
      transform:translateY(1px) scale(.94);
    }

    .theme-toggle-label{
      display:flex;
      flex-direction:column;
      line-height:1.15;
    }
    .theme-toggle-main{
      font-size:11px;
      text-transform:uppercase;
    }
    .theme-toggle-status{
      font-size:10px;
      font-weight:600;
      opacity:0.76;
    }

    /* ===== TOPO / WRAP ===== */
    .wrap{
      max-width:1320px;margin:18px auto 16px;padding:0 18px;flex:1;
    }

    /* ===== CARD ===== */
    .card{
      background:var(--glass-bg);
      border-radius:var(--radius-2xl);
      box-shadow:var(--shadow-sm);
      padding:16px 16px 14px;
      transition:
        transform .18s ease,
        box-shadow .18s ease,
        border-color .18s ease,
        background .25s ease;
      border:1px solid var(--glass-border);
      backdrop-filter:blur(var(--glass-blur));
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow-md);
      border-color:rgba(251,146,60,0.60);
    }

    .btn{
      padding:10px 14px;border:0;border-radius:14px;background:var(--primary);
      color:#fff;font-weight:800;letter-spacing:.2px;cursor:pointer;
      transition:background .16s,transform .08s,box-shadow .16s;
      box-shadow:0 4px 14px rgba(255,87,34,.35);
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn:hover{background:var(--primary-2);box-shadow:0 7px 22px rgba(248,113,113,.55);}
    .btn:active{transform:scale(.985) translateY(1px);box-shadow:0 3px 10px rgba(0,0,0,.35);}
    .btn.small{padding:8px 11px;border-radius:11px;font-weight:800;font-size:12px}
    .btn.secondary{background:#111827;color:#fff;box-shadow:0 4px 14px rgba(15,23,42,.65)}
    .btn.secondary:hover{background:#020617}
    .btn.ghost{background:rgba(255,255,255,0.9);color:#111827;border:1px solid #e5e7eb;box-shadow:none}
    .btn.cancel{background:#f3f4f6;color:#111827;box-shadow:none;border:1px solid var(--line)}
    .btn.full{width:100%}
    .btn:focus{outline:3px solid rgba(255,87,34,.32); outline-offset:2px}
    body.theme-dark .btn.ghost{
      background:rgba(15,23,42,0.95);color:#e5e7eb;border-color:rgba(148,163,184,0.65);
    }
    body.theme-dark .btn.cancel{
      background:#020617;color:#e5e7eb;border-color:rgba(55,65,81,0.85);
    }

    .uploader{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .file{
      display:inline-flex;align-items:center;justify-content:flex-start;min-width:260px;height:44px;
      padding:0 14px;border:1px dashed rgba(148,163,184,0.8);border-radius:14px;background:rgba(255,255,255,0.65);color:#0f172a;
      cursor:pointer;transition:border-color .16s,box-shadow .16s,color .16s,font-weight .16s,background .2s;
      font-size:13px;
    }
    .file::before{
      content:"‚§ì";margin-right:8px;font-size:16px;opacity:.9;
    }
    .file:hover{
      border-color:var(--primary);
      color:var(--primary);
      font-weight:800;
      background:#fff;
      box-shadow:0 9px 22px rgba(15,23,42,0.16);
    }
    body.theme-dark .file{
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      border-color:rgba(75,85,99,0.9);
    }
    body.theme-dark .file:hover{
      background:rgba(15,23,42,0.98);
      box-shadow:0 12px 30px rgba(0,0,0,0.9);
    }

    .muted{color:var(--muted)} 
    .ok{color:var(--ok)} 
    .err{color:var(--err)}
    .chip{
      background:var(--chip);
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      border:1px solid rgba(251,146,60,0.35);
    }
    .chip::before{
      content:"";
      width:5px;height:5px;border-radius:999px;
      background:rgba(248,113,113,0.9);
    }
    .label-strong{font-weight:900;margin:2px 0 6px;font-size:13px;letter-spacing:.18px}

    .grid{display:grid;gap:14px}
    @media(min-width:980px){ .grid{grid-template-columns:1.18fr 1.1fr} }

    .scanbar{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .scanbar input{
      flex:1;min-width:260px;height:44px;padding:0 13px;border:1px solid rgba(209,213,219,0.95);border-radius:13px;font-size:15px;outline:none;background:#fff;
      transition:border-color .14s,box-shadow .16s,transform .08s,background .16s;
      box-shadow:0 2px 4px rgba(15,23,42,0.04);
    }
    .scanbar input::placeholder{color:#9ca3af}
    .scanbar input:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(248,113,113,0.6), 0 10px 25px rgba(15,23,42,0.18);
      background:#fff;
    }
    .scanbar input:active{transform:scale(.997)}
    body.theme-dark .scanbar input{
      background:rgba(15,23,42,0.96);
      border-color:rgba(55,65,81,0.95);
      color:#e5e7eb;
      box-shadow:0 10px 26px rgba(0,0,0,1);
    }
    body.theme-dark .scanbar input::placeholder{color:#6b7280}

    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(164px,1fr));
      gap:10px;
      margin-top:10px;
      align-items:stretch;
    }
    .kpi{
      background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(249,250,251,0.92));
      border:1px solid rgba(229,231,235,0.95);
      border-radius:14px;
      padding:10px 11px;
      display:flex;flex-direction:column;justify-content:space-between;min-height:80px;
      box-shadow:0 10px 26px rgba(15,23,42,0.08);
      position:relative;
      overflow:hidden;
    }
    .kpi::after{
      content:"";
      position:absolute;inset:-40%;
      background:radial-gradient(circle at 0% 0%, rgba(251,146,60,0.18) 0, transparent 43%);
      opacity:.7;
      pointer-events:none;
      mix-blend-mode:soft-light;
    }
    body.theme-dark .kpi{
      background:radial-gradient(circle at 0% 0%, rgba(251,146,60,0.18) 0, transparent 55%),
                 radial-gradient(circle at 100% 100%, rgba(59,130,246,0.25) 0, transparent 65%),
                 rgba(15,23,42,0.98);
      border-color:rgba(55,65,81,0.95);
      box-shadow:0 18px 40px rgba(0,0,0,1);
    }
    .kpi .label{
      color:var(--muted);
      font-size:11px;
      letter-spacing:.35px;
      text-transform:uppercase;
      line-height:1;
      opacity:.95;
    }
    .kpi .value{
      margin-top:7px;
      font-size:18px;
      font-weight:900;
      line-height:1.15;
      white-space:normal;
      font-variant-numeric:tabular-nums;
      text-shadow:0 1px 0 rgba(255,255,255,0.55);
    }
    .kpi .value.mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      letter-spacing:.3px;
    }
    body.theme-dark .kpi .value{
      text-shadow:0 0 0 transparent;
    }

    .tbl-wrap{
      overflow:auto;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,0.96);
      box-shadow:0 8px 18px rgba(15,23,42,0.08);
      margin-top:4px;
    }
    body.theme-dark .tbl-wrap{
      background:rgba(15,23,42,0.96);
      box-shadow:0 20px 40px rgba(0,0,0,1);
    }

    table{width:100%;border-collapse:collapse}
    th,td{
      padding:9px 10px;
      border-bottom:1px solid rgba(226,232,240,0.95);
      text-align:left;
      font-size:13px;
    }
    th{
      color:var(--muted);
      font-weight:800;
      background:linear-gradient(to bottom, rgba(248,250,252,0.98), rgba(241,245,249,0.98));
      position:sticky;top:0;
      z-index:1;
      backdrop-filter:blur(12px);
    }
    body.theme-dark th{
      background:linear-gradient(to bottom, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
      border-bottom-color:rgba(75,85,99,0.95);
    }
    tbody tr{transition:background .12s}
    tbody tr:hover td{
      background:rgba(255,245,242,0.98);
    }
    body.theme-dark tbody tr:hover td{
      background:rgba(30,64,175,0.32);
    }

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .danger{background:#fef2f2;border:1px solid #fde4e4}

    footer{
      text-align:center;
      padding:12px;
      font-size:13px;
      color:var(--muted);
      border-top:1px solid var(--line);
      margin-top:4px;
      backdrop-filter:blur(12px);
      background:linear-gradient(to top, rgba(255,255,255,0.88), rgba(255,255,255,0.82));
    }
    footer b{color:var(--primary)}
    body.theme-dark footer{
      background:linear-gradient(to top, rgba(15,23,42,0.98), rgba(15,23,42,0.95));
      border-top-color:rgba(30,64,175,0.75);
    }

    /* ========== Modal base ========== */
    .modal-overlay{
      position:fixed;inset:0;background:var(--overlay);
      display:none;align-items:center;justify-content:center;z-index:1000;
      padding:16px;
      backdrop-filter:blur(8px);
    }
    .modal{
      background:var(--card);border-radius:var(--radius-2xl);max-width:760px;width:100%;
      box-shadow:var(--shadow-md);overflow:hidden;border:1px solid var(--line);
      animation:pop .15s ease-out;
    }
    @keyframes pop{from{transform:scale(.96) translateY(6px);opacity:.4}to{transform:scale(1) translateY(0);opacity:1}}
    .modal header{
      padding:14px 16px;
      border-bottom:1px solid #e5e7eb;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
    }
    body.theme-dark .modal header{
      border-bottom-color:rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.98);
    }
    .modal .content{padding:14px 16px;line-height:1.45;background:var(--bg-soft)}
    body.theme-dark .modal .content{
      background:rgba(15,23,42,0.98);
    }
    .modal .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .modal .field{display:flex;flex-direction:column;gap:6px;flex:1}
    .modal input,.modal select,.modal textarea{
      height:42px;padding:10px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px;outline:none;background:#fff;
      transition:border-color .16s, box-shadow .16s, background .16s;
    }
    .modal textarea{min-height:80px;resize:vertical}
    .modal input:focus,.modal select:focus,.modal textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(248,113,113,0.6), 0 8px 20px rgba(0,0,0,0.15);
    }
    body.theme-dark .modal input,
    body.theme-dark .modal select,
    body.theme-dark .modal textarea{
      background:rgba(15,23,42,0.96);
      border-color:rgba(55,65,81,0.95);
      color:#e5e7eb;
    }
    .modal footer{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid #e5e7eb;
      padding:12px 14px;
      background:linear-gradient(to top, rgba(248,250,252,0.98), rgba(248,250,252,0.94));
    }
    body.theme-dark .modal footer{
      border-top-color:rgba(55,65,81,0.95);
      background:linear-gradient(to top, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
    }
    .hidden{display:none}

    /* Neighborhood / Address modal list */
    .listbox{
      border:1px solid var(--line);
      border-radius:12px;
      max-height:360px;
      overflow:auto;
      background:#fff;
    }
    .list-head{
      position:sticky;top:0;
      background:#fafafa;
      border-bottom:1px solid var(--line);
      padding:8px 12px;
      font-weight:900;
      color:#444;
      font-size:12px;
      letter-spacing:.18px;
    }
    body.theme-dark .listbox{
      background:rgba(15,23,42,0.98);
      border-color:rgba(55,65,81,0.95);
    }
    body.theme-dark .list-head{
      background:rgba(15,23,42,0.96);
      border-bottom-color:rgba(55,65,81,0.95);
      color:#e5e7eb;
    }
    .list-item{
      display:flex;gap:10px;align-items:center;padding:9px 12px;border-bottom:1px solid #f3f4f6;cursor:pointer;font-size:13px;
    }
    .list-item:hover{background:#fff5f2}
    body.theme-dark .list-item{
      border-bottom-color:rgba(31,41,55,0.96);
    }
    body.theme-dark .list-item:hover{
      background:rgba(30,64,175,0.34);
    }
    .list-item input{margin-right:4px}

    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:3px}
    .chip-x{
      display:inline-flex;
      gap:6px;
      align-items:center;
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:5px 10px;
      font-size:12px;
    }
    .chip-x button{all:unset;cursor:pointer;font-weight:900;opacity:.7}
    .chip-x button:hover{opacity:1}
    body.theme-dark .chip-x{
      background:rgba(15,23,42,0.98);
      border-color:rgba(55,65,81,0.95);
      color:#e5e7eb;
    }

    /* ===== TOAST CENTRAL ===== */
    .toast-center{
      position:fixed;left:50%;top:50%;
      transform:translate(-50%,-50%) scale(.94);
      z-index:1100;display:flex;flex-direction:column;align-items:center;gap:6px;
      background:#fff;border:1px solid var(--line);
      padding:16px 18px;border-radius:16px;
      box-shadow:0 18px 60px rgba(15,23,42,.45);
      animation:toast-pop .9s ease-in-out forwards;
      max-width:320px;
      text-align:center;
    }
    body.theme-dark .toast-center{
      background:rgba(15,23,42,0.98);
      border-color:rgba(55,65,81,0.95);
      box-shadow:0 26px 80px rgba(0,0,0,1);
    }
    .toast-center .icon{ width:56px;height:56px;display:block;filter: drop-shadow(0 6px 14px rgba(0,0,0,.18)); }
    .toast-center .title{ font-weight:900; letter-spacing:.2px; }
    .toast-success .title{ color:var(--ok); }
    .toast-error .title{ color:var(--err); }
    .toast-center .subtitle{ font-size:12px; color:var(--muted); }
    @keyframes toast-pop{
      0%   { opacity:0; transform:translate(-50%,-50%) scale(.92) }
      15%  { opacity:1; transform:translate(-50%,-50%) scale(1.02) }
      60%  { opacity:1; transform:translate(-50%,-50%) scale(1.0) }
      100% { opacity:0; transform:translate(-50%,-54%) scale(.98) }
    }

    /* ===== Overlay de carregamento ===== */
    .loading-overlay{
      position:fixed; inset:0; z-index:900;
      background:rgba(255,255,255,.90); backdrop-filter:blur(4px);
      display:none; align-items:center; justify-content:center;
    }
    body.theme-dark .loading-overlay{
      background:rgba(15,23,42,0.94);
    }
    .loading-box{
      background:#fff; border:1px solid var(--line); border-radius:16px;
      padding:16px 18px; box-shadow:var(--shadow-md); display:flex; gap:12px; align-items:center;
      font-weight:900;
    }
    body.theme-dark .loading-box{
      background:rgba(15,23,42,0.98);
      border-color:rgba(55,65,81,0.95);
    }
    .spinner{
      width:22px; height:22px; border-radius:50%;
      border:3px solid #e5e7eb; border-top-color: var(--primary);
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ===== Detalhes extras de UI ===== */
    .chipCheck{display:inline-flex;align-items:center;margin:4px 6px 0 0}
    .chipCheck input{display:none}
    .chipCheck .chip{border:1px solid #eee; user-select:none; cursor:pointer}
    .chipCheck input:checked + .chip{
      border-color:var(--primary); 
      box-shadow:0 0 0 3px rgba(255,87,34,.10);
      background:rgba(255,247,237,0.98);
    }
    body.theme-dark .chipCheck .chip{
      border-color:rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.98);
      color:#e5e7eb;
    }
    body.theme-dark .chipCheck input:checked + .chip{
      background:rgba(30,64,175,0.6);
      border-color:rgba(59,130,246,0.95);
      box-shadow:0 0 0 1px rgba(59,130,246,0.85);
    }

    .warn-badge{
      display:inline-flex;align-items:center;gap:6px;background:#fff7ed;border:1px solid #ffedd5;color:#9a3412;padding:4px 8px;border-radius:999px;font-size:12px;
    }
    code{
      background:#fff7f4;
      border:1px solid #ffe2d6;
      border-radius:6px;
      padding:1px 6px;
      font-size:12px;
    }
    body.theme-dark code{
      background:rgba(15,23,42,0.98);
      border-color:rgba(55,65,81,0.95);
      color:#e5e7eb;
    }
    .dropzone.dragover{
      border-color:var(--primary); 
      box-shadow:0 0 0 6px rgba(255,87,34,.10);
      background:rgba(255,255,255,0.98);
    }
    body.theme-dark .dropzone.dragover{
      background:rgba(15,23,42,0.98);
    }

    /* Badge (+n) de adicionados */
    .chip-add{
      display:inline-flex;align-items:center;gap:4px;
      background:#fff3ec;border:1px solid #ffd9c9;color:#b34b1c;
      padding:2px 8px;border-radius:999px;font-size:12px;font-weight:900;margin-left:6px;
    }
    body.theme-dark .chip-add{
      background:rgba(30,64,175,0.6);
      border-color:rgba(59,130,246,0.9);
      color:#e5e7eb;
    }

    /* ===== Splash de boas-vindas (r√°pido) ===== */
    .splash{
      position:fixed; inset:0; z-index:1400;
      display:flex; align-items:center; justify-content:center;
      background:#ffffff;
    }
    .splash .box{
      display:flex; flex-direction:column; align-items:center; gap:10px;
      padding:22px 26px; border:1px solid var(--line); border-radius:18px;
      box-shadow:var(--shadow-md); background:#fff;
      transform:scale(.98); opacity:0; animation:splash-in .25s ease-out forwards;
    }
    .splash img{ width:120px; height:120px; object-fit:contain; }
    .splash .title{ font-weight:900; font-size:18px; letter-spacing:.2px }
    .splash .sub{ color:var(--muted); font-size:14px; font-weight:700; letter-spacing:.2px }
    @keyframes splash-in{ to{ opacity:1; transform:scale(1)} }
    .splash.hide{ animation:splash-out .35s ease-in forwards }
    @keyframes splash-out{ to{ opacity:0; transform:scale(.985)} }
  </style>
</head>
<body>

<!-- Splash r√°pido de boas-vindas (aparece s√≥ na 1¬™ visita) -->
<div id="splash" class="splash" aria-hidden="true">
  <div class="box">
    <img src="https://media.giphy.com/media/Pj8pBI65xL1mKBBSiM/giphy.gif" alt="Bem-vindo">
    <div class="title">Bem-vindo(a)!</div>
    <div class="sub">Realocamento carregando‚Ä¶</div>
  </div>
</div>

<!-- Appbar -->
<div class="appbar">
  <div class="appbar-inner">
    <div class="brand">
      <div class="logo"></div>
      <div class="brand-text">
        <h1><b>SPR</b> ‚Ä¢ Realocamento de Pacotes 3.0</h1>
        <div class="brand-sub">Realocamento ‚Ä¢ Inteligente</div>
      </div>
    </div>

    <div class="header-actions">
      <!-- Bot√£o "Realocamento Inteligente" / tema -->
      <button type="button" class="theme-toggle" id="themeToggle" title="Alternar modo claro/escuro">
        <div class="theme-toggle-bulb">
          <span>üí°</span>
        </div>
        <div class="theme-toggle-label">
          <span class="theme-toggle-main">Realocamento Inteligente</span>
          <span class="theme-toggle-status" id="themeStatus">Luz acesa (modo claro)</span>
        </div>
      </button>
    </div>
  </div>
</div>

<div class="wrap">

  <!-- Uploader -->
  <section class="card">
    <div class="uploader">
      <label class="file dropzone" id="dropzone" for="file">Arraste ou clique para selecionar</label>
      <input id="file" type="file" accept=".xlsx,.xls" style="display:none" />
      <button class="btn" id="btnLoad">Carregar planilha</button>
      <button class="btn" id="btnLoadSheets" title="Ler dados do Google Sheets (CTs)">Ler Romaneio Sheets</button>
      <button class="btn secondary" id="btnReset" title="Limpa base e resultados">Limpar base</button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div id="loadMsg" class="muted">Aba padr√£o: <b>Planilha1</b></div>
      </div>
    </div>
  </section>

  <div class="grid" style="margin-top:14px">
    <!-- COLUNA ESQUERDA -->
    <section class="card">
      <div class="uploader" style="justify-content:space-between;margin-bottom:4px">
        <div><b>Base:</b> <span id="baseInfo" class="muted">nenhuma carregada</span></div>
        <div class="muted" id="sheetInfo"></div>
      </div>

      <div class="scanbar">
        <input id="scan" placeholder="Bipe/insira o BRS... (Enter)" autocomplete="off" disabled />
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnScan" disabled>Bipar</button>
          <button class="btn secondary" id="btnNeighModal" disabled>Pesquisar por Neighborhood</button>
          <button class="btn secondary" id="btnAddrModal" disabled>Pesquisar por Endere√ßo</button>
        </div>
      </div>
      <div id="scanMsg" class="muted" style="margin-top:6px">Carregue a planilha para habilitar a busca.</div>

      <div id="resultLeft" style="margin-top:10px; display:none">
        <div class="kpis">
          <div class="kpi"><div class="label">BRS</div><div class="value mono" id="kBRS">‚Äî</div></div>
          <div class="kpi"><div class="label">Corridor Cage</div><div class="value" id="kRota">‚Äî</div></div>
          <div class="kpi"><div class="label">Bairro</div><div class="value" id="kBairro">‚Äî</div></div>
          <div class="kpi"><div class="label">Planned Vehicle Type</div><div class="value" id="kVeiculo">‚Äî</div></div>
          <div class="kpi"><div class="label">AT (Planned)</div><div class="value mono" id="kAT">‚Äî</div></div>
        </div>
      </div>
    </section>

    <!-- COLUNA DIREITA -->
    <aside class="card" id="rightPane">
      <div id="resultRight" style="display:none">
        <div>
          <div class="label-strong">Endere√ßo (Destination Address)</div>
          <div id="kEndereco" class="card" style="padding:10px;border:1px solid #eee;margin-top:4px"></div>
        </div>

        <div id="filterBar" style="margin-top:12px; display:none">
          <div class="label-strong">Filtrar por <span class="chip">Planned Vehicle Type</span></div>
          <div id="vehicleChips" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px"></div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button class="btn secondary small" id="btnAll">Selecionar todos</button>
            <button class="btn secondary small" id="btnNone">Limpar</button>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="label-strong">Rotas com o mesmo <span class="chip">Neighborhood</span></div>
          <div class="muted" id="sameInfo" style="margin-top:2px">‚Äî</div>
          <div class="tbl-wrap" style="margin-top:8px">
            <table id="sameTable">
              <thead>
                <tr>
                  <th>Corridor Cage</th>
                  <th>Bairro</th>
                  <th>Ve√≠culo</th>
                  <th>Qtd. Pacotes (Total)</th>
                  <th>Quantidade no bairro</th>
                  <th>A√ß√£o</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="placeholderRight" class="muted">Bipe um BRS ou use a pesquisa por Neighborhood ou Endere√ßo para listar as rotas.</div>
    </aside>
  </div>

  <!-- SELE√á√ïES / REALLOCA√á√ïES -->
  <section class="card" style="margin-top:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div class="label-strong">Realoca√ß√µes selecionadas</div>
      <div class="actions">
        <button class="btn small ghost" id="btnCopy" title="Copiar BR e AT para a √°rea de transfer√™ncia">Copiar BR e AT</button>
        <button class="btn small ghost" id="btnClearSel" title="Limpar tabela">Limpar</button>
        <button class="btn small" id="btnExport">Exportar (.xlsx)</button>
        <button class="btn small" id="btnSendSheets" title="Enviar para Google Sheets">Enviar p/ Sheets</button>
      </div>
    </div>
    <div class="muted" id="selInfo" style="margin-top:6px">Sem itens.</div>
    <div class="tbl-wrap" style="margin-top:6px">
      <table id="selTable">
        <thead>
          <tr>
            <th>BR &amp; Protocolo</th>
            <th>AT &amp; Protocolo</th>
            <th>Rota</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</div>

<footer>
  Criado por <b>Richard Lucas ‚Äì LSP 12 Adriana</b>
</footer>

<!-- Overlays -->
<div id="toastRoot"></div>
<div id="loading" class="loading-overlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <div id="loadingMsg">Lendo arquivo‚Ä¶</div>
  </div>
</div>

<!-- ========= Modals ========= -->
<div id="overlay" class="modal-overlay">

  <!-- Info gen√©rica -->
  <div id="infoModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <header id="infoTitle">Informa√ß√£o</header>
    <div class="content" id="infoBody"></div>
    <footer>
      <button class="btn cancel" onclick="closeModal()">Fechar</button>
    </footer>
  </div>

  <!-- Modal: Pesquisa por Neighborhood (MULTI) -->
  <div id="neighModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="neighTitle">
    <header id="neighTitle">Pesquisar por Neighborhood</header>
    <div class="content">
      <div class="row">
        <div class="field">
          <label><b>Buscar</b></label>
          <input id="neighQuery" placeholder="Digite para filtrar os bairros" autocomplete="off">
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn small ghost" id="btnNeighSelectAll" title="Selecionar todos vis√≠veis">Selecionar todos</button>
          <button class="btn small ghost" id="btnNeighClear">Limpar</button>
        </div>
      </div>

      <div class="listbox" id="neighList" style="margin-top:8px">
        <div class="list-head">Bairros</div>
      </div>

      <div style="margin-top:8px">
        <div class="label-strong">Selecionados</div>
        <div id="neighChips" class="chips"></div>
      </div>
    </div>
    <footer>
      <button class="btn cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn" id="btnNeighApply">Aplicar</button>
    </footer>
  </div>

  <!-- Modal: Pesquisa por Destination Address (MULTI) -->
  <div id="addrModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="addrTitle">
    <header id="addrTitle">Pesquisar por Endere√ßo</header>
    <div class="content">
      <div class="row">
        <div class="field">
          <label><b>Buscar</b></label>
          <input id="addrQuery" placeholder="Digite para filtrar os endere√ßos" autocomplete="off">
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn small ghost" id="btnAddrSelectAll" title="Selecionar todos vis√≠veis">Selecionar todos</button>
          <button class="btn small ghost" id="btnAddrClear">Limpar</button>
        </div>
      </div>

      <div class="listbox" id="addrList" style="margin-top:8px">
        <div class="list-head">Endere√ßos</div>
      </div>

      <div style="margin-top:8px">
        <div class="label-strong">Selecionados</div>
        <div id="addrChips" class="chips"></div>
      </div>
    </div>
    <footer>
      <button class="btn cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn" id="btnAddrApply">Aplicar</button>
    </footer>
  </div>

  <!-- Modal: Inserir BR (para modo Neighborhood/Endere√ßo) -->
  <div id="brModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="brTitle">
    <header id="brTitle">Adicionar BR para a rota</header>
    <div class="content">
      <div class="field">
        <label for="brInput"><b>BR &amp; Protocolo</b></label>
        <input id="brInput" placeholder="Cole ou digite o BR (pode n√£o existir na base)">
      </div>
      <p class="muted" id="brHint" style="margin-top:6px">O BR pode n√£o estar na base; ser√° aceito mesmo assim.</p>
    </div>
    <footer>
      <button class="btn cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn" id="btnBrConfirm">Adicionar</button>
    </footer>
  </div>

  <!-- sheets form modal (ENVIAR) -->
  <div id="sheetsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="sheetsTitle">
    <header id="sheetsTitle">Enviar para Google Sheets</header>
    <div class="content">
      <div class="field">
        <label for="sheetUrl"><b>Insira aqui o link do Romaneio do dia feito pela roteiriza√ß√£o</b></label>
        <input id="sheetUrl" placeholder="Cole aqui o link completo da planilha">
      </div>

      <div class="row" style="margin-top:8px">
        <div class="field">
          <label for="sheetTab"><b>Escolha a aba de destino</b></label>
          <select id="sheetTab" disabled>
            <option value="">Cole a URL para listar as abas‚Ä¶</option>
          </select>
        </div>
        <div class="field">
          <label for="startCell"><b>C√©lula inicial</b> (ex.: <code>A1</code>)</label>
          <input id="startCell" value="A1" placeholder="A1">
        </div>
      </div>

      <p class="muted" style="margin-top:10px">
        Ser√£o enviados <b>apenas</b> os valores <span class="chip">BR</span> e <span class="chip">AT</span> (sem cabe√ßalho).
      </p>
    </div>
    <footer>
      <button class="btn cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn" id="btnDoSend">Enviar</button>
    </footer>
  </div>

  <!-- sheets import modal (LER DO SHEETS) -->
  <div id="importModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="importTitle">
    <header id="importTitle">Ler base do Google Sheets</header>
    <div class="content">
      <div class="field">
        <label for="importUrl"><b>Insira aqui o link do Romaneio do dia feito pela roteiriza√ß√£o</b></label>
        <input id="importUrl" placeholder="Cole aqui o link completo da planilha">
      </div>

      <div class="row" style="margin-top:8px">
        <div class="field">
          <label for="importTab"><b>Aba para leitura</b> (padr√£o: <code>Calculation Tasks (CTs)</code>)</label>
          <select id="importTab" disabled>
            <option value="">Cole a URL para listar as abas‚Ä¶</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <div class="muted" id="importHint">Lemos todas as colunas existentes (A:ZZZ) e normalizamos como no Excel.</div>
        </div>
      </div>
    </div>
    <footer>
      <button class="btn cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn" id="btnDoImport">Carregar</button>
    </footer>
  </div>
</div>

<script>
/* ====== OAuth (GIS) ====== */
const CLIENT_ID = '800747129509-98obq6okp3t6prjr9u1j2m5od2ip857n.apps.googleusercontent.com';
const SCOPES = 'openid email https://www.googleapis.com/auth/spreadsheets';
const ENFORCE_SHOPEE = true;

let accessToken = null;
let tokenClient = null;
let currentEmail = null;

/* ====== Persist√™ncia por usu√°rio ====== */
const LS_PREFIX = 'spr_realloc_history_';
const LS_LAST_SHEET = 'spr_realloc_last_sheet_';
const LS_VEH = 'veh_filter';
const LS_LAST_BASE = 'last_base_info';
const SPLASH_KEY = 'spr_welcome_seen_v1';
const LS_THEME = 'spr_theme_mode';

/* NOVO: contadores por rota */
const LS_ADDED_COUNTS_PREFIX = 'spr_added_counts_';

function storageKey(){ return LS_PREFIX + (currentEmail || 'anon'); }
function lastSheetKey(){ return LS_LAST_SHEET + (currentEmail || 'anon'); }
function addedCountsKey(){ return LS_ADDED_COUNTS_PREFIX + (currentEmail || 'anon'); }

/* ====== Utils/UI ====== */
const $ = s => document.querySelector(s);
function focusScan(){ setTimeout(()=>$("#scan").focus(), 0); }
function showLoading(msg='Carregando‚Ä¶'){ const el=$("#loading"); $("#loadingMsg").textContent=msg; el.style.display='flex'; }
function hideLoading(){ $("#loading").style.display='none'; }
function showToastCenter({ok=true, title, subtitle}){
  const root = document.getElementById('toastRoot');
  const box = document.createElement('div');
  box.className = `toast-center ${ok?'toast-success':'toast-error'}`;
  const img = document.createElement('img');
  const svg = ok
    ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="#16a34a"/><path d="M18 34l9 9 19-20" fill="none" stroke="#fff" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/></svg>`
    : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="#dc2626"/><path d="M22 22l20 20M42 22L22 42" fill="none" stroke="#fff" stroke-width="6" stroke-linecap="round"/></svg>`;
  img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  img.className = 'icon';
  img.alt = ok ? 'Sucesso' : 'Erro';
  const t = document.createElement('div'); t.className='title'; t.textContent = title || (ok?'Sucesso':'Erro');
  const s = document.createElement('div'); s.className='subtitle'; s.textContent = subtitle || '';
  box.appendChild(img); box.appendChild(t); if(subtitle) box.appendChild(s);
  root.appendChild(box); box.addEventListener('animationend', ()=> box.remove());
}

/* Sons curtos */
function playAddedSound(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain(); const now = ctx.currentTime;
    o.type='triangle'; o.frequency.setValueAtTime(880, now); o.frequency.exponentialRampToValueAtTime(1320, now+0.12);
    g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.25, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+0.18);
    o.connect(g).connect(ctx.destination); o.start(); o.stop(now+0.2);
  }catch(_){}
}
function playErrorSound(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain(); const now = ctx.currentTime;
    o.type='square'; o.frequency.setValueAtTime(300, now); o.frequency.exponentialRampToValueAtTime(160, now+0.15);
    g.gain.setValueAtTime(0.25, now); g.gain.exponentialRampToValueAtTime(0.0001, now+0.2);
    o.connect(g).connect(ctx.destination); o.start(); o.stop(now+0.22);
  }catch(_){}
}

/* ====== Tema (Realocamento Inteligente) ====== */
function applyTheme(theme){
  const body = document.body;
  const statusEl = document.getElementById('themeStatus');
  if(theme === 'dark'){
    body.classList.add('theme-dark');
    if(statusEl) statusEl.textContent = 'Luz apagada (modo escuro)';
  }else{
    body.classList.remove('theme-dark');
    if(statusEl) statusEl.textContent = 'Luz acesa (modo claro)';
  }
  try{ localStorage.setItem(LS_THEME, theme); }catch(_){}
}

/* ====== Modal helpers ====== */
const overlay = $("#overlay");
const infoModal = $("#infoModal");
const sheetsModal = $("#sheetsModal");
const importModal = $("#importModal");
const neighModal = $("#neighModal");
const addrModal  = $("#addrModal");
const brModal = $("#brModal");

function openModal(which){
  overlay.style.display = 'flex';
  [infoModal, sheetsModal, importModal, neighModal, addrModal, brModal].forEach(x=>x.classList.add('hidden'));
  which.classList.remove('hidden');
}
function closeModal(){ overlay.style.display = 'none'; }
function showInfo(title, html){
  $("#infoTitle").textContent = title || 'Informa√ß√£o';
  $("#infoBody").innerHTML = html || '';
  openModal(infoModal);
}

/* ====== Persist√™ncia / Sele√ß√µes ====== */
let SELECTED = []; // {brs, at, rota}
function saveHistory(){ try{ localStorage.setItem(storageKey(), JSON.stringify(SELECTED)); }catch(_){} }
function loadHistoryForCurrentUser(){
  try{
    const raw = localStorage.getItem(storageKey());
    if(raw){ SELECTED = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : []; renderSelections(); }
  }catch(_){}
}

/* ====== NOVO: contadores adicionados por rota ====== */
let ADDED_COUNTS = {}; // { [rota]: number }
function loadAddedCounts(){
  try{
    const raw = localStorage.getItem(addedCountsKey());
    ADDED_COUNTS = raw ? JSON.parse(raw) : {};
  }catch(_){ ADDED_COUNTS = {}; }
}
function saveAddedCounts(){
  try{ localStorage.setItem(addedCountsKey(), JSON.stringify(ADDED_COUNTS)); }catch(_){}
}
function getAddedCount(cage){
  return Math.max(0, Number(ADDED_COUNTS[cage] || 0));
}
function incAddedCount(cage, n=1){
  if(!cage) return;
  ADDED_COUNTS[cage] = getAddedCount(cage) + n;
  saveAddedCounts();
  rerenderSame();
}
function decAddedCount(cage, n=1){
  if(!cage) return;
  ADDED_COUNTS[cage] = Math.max(0, getAddedCount(cage) - n);
  saveAddedCounts();
  rerenderSame();
}
function clearAddedCounts(){
  ADDED_COUNTS = {};
  saveAddedCounts();
  rerenderSame();
}

/* ====== OAuth init ====== */
window.onload = () => {
  if (window.google?.accounts?.oauth2) {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: async (resp) => {
        if (resp.error) { showInfo('Erro OAuth', 'Erro: ' + resp.error); return; }
        accessToken = resp.access_token;
        try{
          if (ENFORCE_SHOPEE) await gatekeepShopee(accessToken);
          currentEmail = await getUserEmail(accessToken);
          loadHistoryForCurrentUser();
          loadAddedCounts();
        }catch(e){
          showInfo('Acesso negado', e.message || e);
          google.accounts.oauth2.revoke(accessToken);
          accessToken = null; currentEmail = null;
        }
      }
    });
  }
};
async function ensureAuth(){
  if (!tokenClient) {
    if (!window.google || !google.accounts || !google.accounts.oauth2) {
      showInfo('Aguarde', 'Google Identity ainda n√£o carregou. Tente novamente em 1‚Äì2 segundos.');
      throw new Error('GIS n√£o carregado');
    }
    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: () => {} });
  }
  if (accessToken) return true;

  return new Promise((resolve, reject) => {
    tokenClient.callback = async (resp) => {
      if (resp.error) return reject(resp);
      accessToken = resp.access_token;
      try {
        if (ENFORCE_SHOPEE) await gatekeepShopee(accessToken);
        currentEmail = await getUserEmail(accessToken);
        loadHistoryForCurrentUser();
        loadAddedCounts();
        resolve(true);
      } catch (e) {
        google.accounts.oauth2.revoke(accessToken);
        accessToken = null; currentEmail = null;
        reject(e);
      }
    };
    tokenClient.requestAccessToken({ prompt: 'consent' });
  });
}
async function getUserEmail(token){
  const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${token}` } });
  if (!r.ok) throw new Error('Falha ao obter userinfo');
  const data = await r.json();
  return String(data.email||'').toLowerCase();
}
async function gatekeepShopee(token){
  const email = await getUserEmail(token);
  const ok =
    /@shopee\.com$/i.test(email) ||
    /@shopeemobile-external\.com$/i.test(email);
  if (!ok) {
    throw new Error('Acesso permitido apenas para contas @shopee.com ou @shopeemobile-external.com');
  }
}

/* ========= Utilidades ========= */
const stripAccents = (s='') => String(s).normalize('NFD').replace(/\p{Diacritic}/gu,'');
const norm = (s='') => stripAccents(String(s).trim()).toLowerCase();
const normBRS = (s='') => String(s).toUpperCase().replace(/[^A-Z0-9]/g,'');
const isExcel = f => /\.(xlsx|xls)$/i.test(f?.name||'');
function debounce(fn, ms=160){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

/* ========= Mapeamento/normaliza√ß√£o ========= */
const COLS_EXT = {
  brs:        ['SPX TN','BRS','Codigo','C√≥digo','Code','Tracking','AWB'],
  endereco:   ['Destination Address','Address','REGIAO','REGI√ÉO'],
  bairro:     ['Neighborhood','BAIRRO','Bairro'],
  plannedAt:  ['AT & Protocolo','AT (Planned)','Planned AT','Delivery Time','PlannedAT','AT','Planned_At'],
  veiculo:    ['Planned Vehicle Type','Location Type','Tipo de ve√≠culo','Veiculo','Vehicle Type','Tipo'],
  cluster:    ['Corridor Cage','Cluster','Rota','Route','Route Name','Cluster Name']
};
function pick(row, names){
  for(const candidate of names){
    const exact = row[candidate];
    if(exact !== undefined && exact !== null && exact !== '') return String(exact).trim();
    const target = norm(candidate);
    for(const k of Object.keys(row)){
      if(norm(k) === target){
        const val = row[k];
        if(val !== undefined && val !== null && val !== '') return String(val).trim();
      }
    }
  }
  return '';
}

/* ========= Estado ========= */
let BASE_ROWS = [];
let INDEX_BRS = new Map();
let INDEX_BAIRRO_CLUSTER = new Map(); // key(bairro sem acento) -> Map(cage -> rows[])
let INDEX_ADDRESS_CLUSTER = new Map(); // key(endere√ßo sem acento) -> {endereco, bairro, cages: Map(cage -> rows[])}
let INDEX_TOTAL_BY_CAGE = new Map();
let VEH_TYPES = [];
let VEH_FILTER = new Set();
let LAST_ROW = null;
let LAST_SAME = [];

/* Neighborhood modal state */
let NEIGH_SELECTED = new Set();
let NEIGH_PENDING_TARGET = null; // {cage, rows} para modal de BR

/* Address modal state */
let ADDR_SELECTED = new Set();

/* ========= Excel ========= */
function parseSheetToObjects(ws){
  const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:false});
  return json.map(r=>{ const o={}; Object.keys(r).forEach(k=>{ o[String(k).trim()] = r[k]; }); return o; });
}
function formatMaybeDate(v){
  if(!v) return '';
  if(/^\d+(\.\d+)?$/.test(String(v))){
    try{
      const date = XLSX.SSF.parse_date_code(Number(v));
      if(date){
        const js = new Date(Date.UTC(date.y, date.m-1, date.d, date.H||0, date.M||0, Math.floor(date.S||0)));
        return js.toLocaleString();
      }
    }catch(e){}
  }
  return String(v);
}
function normalizeFromExt(row){
  const out = {
    brs:      pick(row, COLS_EXT.brs),
    endereco: pick(row, COLS_EXT.endereco),
    bairro:   pick(row, COLS_EXT.bairro),
    at:       pick(row, COLS_EXT.plannedAt),
    veiculo:  pick(row, COLS_EXT.veiculo),
    rota:     pick(row, COLS_EXT.cluster)
  };
  if(/^\d+(\.\d+)?$/.test(out.at)) out.at = formatMaybeDate(out.at);
  return out;
}

/* ========= √çndices ========= */
function buildIndexes(){
  INDEX_BRS.clear();
  INDEX_BAIRRO_CLUSTER.clear();
  INDEX_ADDRESS_CLUSTER.clear();
  INDEX_TOTAL_BY_CAGE.clear();

  for(const r of BASE_ROWS){
    if(r.brs) INDEX_BRS.set(normBRS(r.brs), r);

    // √çndice por bairro
    if(r.bairro){
      const key = stripAccents(String(r.bairro)).trim();
      if(!INDEX_BAIRRO_CLUSTER.has(key)) INDEX_BAIRRO_CLUSTER.set(key, new Map());
      const mapC = INDEX_BAIRRO_CLUSTER.get(key);
      const keyC = r.rota || '(sem rota)';
      if(!mapC.has(keyC)) mapC.set(keyC, []);
      mapC.get(keyC).push(r);
    }

    // √çndice por endere√ßo (Destination Address) ‚Äì √∫nico por texto de endere√ßo
    if(r.endereco){
      const keyA = stripAccents(String(r.endereco)).trim();
      if(!INDEX_ADDRESS_CLUSTER.has(keyA)){
        INDEX_ADDRESS_CLUSTER.set(keyA, {
          endereco: r.endereco,
          bairro: r.bairro || '',
          cages: new Map()
        });
      }
      const obj = INDEX_ADDRESS_CLUSTER.get(keyA);
      const mapAC = obj.cages;
      const cageA = r.rota || '(sem rota)';
      if(!mapAC.has(cageA)) mapAC.set(cageA, []);
      mapAC.get(cageA).push(r);
    }

    const cage = r.rota || '(sem rota)';
    INDEX_TOTAL_BY_CAGE.set(cage, (INDEX_TOTAL_BY_CAGE.get(cage)||0) + 1);
  }

  const enableNeigh = INDEX_BAIRRO_CLUSTER.size > 0;
  const btnNeigh = $("#btnNeighModal");
  if(btnNeigh) btnNeigh.disabled = !enableNeigh;

  const enableAddr = INDEX_ADDRESS_CLUSTER.size > 0;
  const btnAddr = $("#btnAddrModal");
  if(btnAddr) btnAddr.disabled = !enableAddr;
}

/* ========= Filtro de ve√≠culos ========= */
function rebuildVehicleFilterFromBase(){
  const set = new Set();
  for(const r of BASE_ROWS){ if(r.veiculo){ set.add(String(r.veiculo).trim()); } }
  VEH_TYPES = Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR',{numeric:true}));
  const saved = JSON.parse(localStorage.getItem(LS_VEH)||'null');
  VEH_FILTER = new Set(Array.isArray(saved) ? saved : VEH_TYPES);
  renderFilterUI();
}
function renderFilterUI(){
  const bar  = $("#filterBar");
  const wrap = $("#vehicleChips");
  wrap.innerHTML = "";
  VEH_TYPES.forEach(t=>{
    const id = 'veh_'+t.replace(/\W+/g,'_');
    const label = document.createElement('label');
    label.className = 'chipCheck';
    label.innerHTML = `<input type="checkbox" id="${id}" value="${t}" ${VEH_FILTER.has(t)?'checked':''}><span class="chip">${t}</span>`;
    wrap.appendChild(label);
    label.querySelector('input').addEventListener('change', e=>{
      if(e.target.checked) VEH_FILTER.add(t); else VEH_FILTER.delete(t);
      localStorage.setItem(LS_VEH, JSON.stringify(Array.from(VEH_FILTER)));
      rerenderSame();
    });
  });
  bar.style.display = VEH_TYPES.length ? 'block' : 'none';

  $("#btnAll").onclick = ()=>{ VEH_FILTER = new Set(VEH_TYPES); persistAndSync(); };
  $("#btnNone").onclick= ()=>{ VEH_FILTER.clear(); persistAndSync(); };
  function persistAndSync(){
    localStorage.setItem(LS_VEH, JSON.stringify(Array.from(VEH_FILTER)));
    wrap.querySelectorAll('input[type="checkbox"]').forEach(ch=> ch.checked = VEH_FILTER.has(ch.value));
    rerenderSame();
  }
}

/* ========= Carregar arquivo local ========= */
async function handleLoad(inputFile){
  const file = inputFile || $("#file").files[0];
  if(!file){ showInfo('Arquivo', 'Selecione um arquivo <b>.xlsx</b>.'); return; }
  if(!isExcel(file)){ showInfo('Arquivo inv√°lido', 'Use arquivos <b>.xlsx</b> ou <b>.xls</b>.'); return; }
  showLoading('Lendo arquivo...');

  try{
    const buf = await file.arrayBuffer();
    const wb  = XLSX.read(buf, {type:'array'});
    let extName = wb.SheetNames.find(n => n.trim().toLowerCase() === 'planilha1') || wb.SheetNames[0];
    const wsExt = wb.Sheets[extName];
    const rowsExt = parseSheetToObjects(wsExt);

    BASE_ROWS = rowsExt.map(normalizeFromExt).filter(r=>r.brs || r.bairro || r.endereco);
    buildIndexes();
    rebuildVehicleFilterFromBase();

    $("#baseInfo").textContent = `${BASE_ROWS.length} linhas carregadas`;
    $("#sheetInfo").textContent = `Aba usada: ${extName}`;
    $("#scan").disabled = false; $("#btnScan").disabled = false;
    $("#btnNeighModal").disabled = false;
    $("#btnAddrModal").disabled = false;
    $("#scanMsg").innerHTML = '<span class="ok">Base carregada! J√° pode bipar ou pesquisar Neighborhood / Endere√ßo.</span>';

    const when = new Date().toLocaleString();
    $("#loadMsg").innerHTML = `<span class="ok">Arquivo "<b>${file.name}</b>" lido (${BASE_ROWS.length} linhas) em ${when}.</span>`;
    localStorage.setItem(LS_LAST_BASE, JSON.stringify({name:file.name, rows:BASE_ROWS.length, when:Date.now()}));

    hideLoading();
    showToastCenter({ok:true, title:'Pacotes prontos', subtitle:'Base carregada (arquivo)'});    
    focusScan();
  }catch(e){
    hideLoading();
    showToastCenter({ok:false, title:'Falha ao ler o Excel'});
    showInfo('Falha ao ler o Excel', e.message);
  }
}

/* ========= Helpers ========= */
function pickRepresentativeAT(rows){
  const freq = new Map();
  for(const r of rows){
    const key = (r.at || '').trim();
    if(!key) continue;
    freq.set(key, (freq.get(key)||0) + 1);
  }
  let best = '', bestN = -1;
  for(const [k,v] of freq.entries()){ if(v>bestN){ best=k; bestN=v; } }
  return best || (rows[0]?.at || '');
}

/* ========= Busca e render ========= */
function findSameNeighborhoodGrouped(bairro){
  const key = stripAccents(String(bairro||'').trim());
  const mapC = INDEX_BAIRRO_CLUSTER.get(key);
  if(!mapC) return [];
  return Array.from(mapC.entries()).map(([cage,rows])=>({cage,rows,bairro}));
}

/**
 * context:
 *  - 'scan'  ‚Üí fluxo normal ap√≥s bipar BRS
 *  - 'neigh' ‚Üí pesquisa por Neighborhood (multi)
 *  - 'addr'  ‚Üí pesquisa por Endere√ßo (multi)
 */
function fillSameTable(groups, labelForGroup, context){
  const tbody = $("#sameTable tbody"); tbody.innerHTML = "";
  let labelInfo = '';
  if(context === 'neigh'){
    labelInfo = groups.length
      ? `Encontradas ${groups.length} rotas nas sele√ß√£o(√µes) de Neighborhood.`
      : "Nenhuma rota para os bairros selecionados.";
  }else if(context === 'addr'){
    labelInfo = groups.length
      ? `Encontradas ${groups.length} rotas nos endere√ßo(s) selecionados.`
      : "Nenhuma rota para os endere√ßos selecionados.";
  }else{
    labelInfo = groups.length
      ? `Encontradas ${groups.length} rotas com o mesmo Neighborhood.`
      : "Nenhuma outra rota com o mesmo Neighborhood.";
  }
  $("#sameInfo").textContent = labelInfo;

  groups.forEach(g=>{
    const qtdNoBairro = g.rows.length;
    const veiculo = g.rows[0]?.veiculo || '‚Äî';
    const isFiorino = /fiorino/i.test(veiculo);
    const totalCage = INDEX_TOTAL_BY_CAGE.get(g.cage) || qtdNoBairro;
    const bairroShown = g.bairro || labelForGroup || '‚Äî';

    let statusHtml = '';
    if(qtdNoBairro <= 3 && !isFiorino){
      statusHtml = `<span class="warn-badge" title="Poucos pacotes neste bairro">‚ö†Ô∏è ${qtdNoBairro} <small>(poucos)</small></span>`;
    }else{
      statusHtml = `<span class="ok" title="Quantidade no bairro">${qtdNoBairro}</span>`;
    }

    const added = getAddedCount(g.cage);
    const addedHtml = added ? `<span class="chip-add">+${added}</span>` : '';

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="chip">${g.cage}</span></td>
      <td>${bairroShown}</td>
      <td>${veiculo}</td>
      <td>${totalCage} ${addedHtml}</td>
      <td>${statusHtml}</td>
      <td><button class="btn small" data-cage="${g.cage}">Adicionar nesta rota</button></td>
    `;
    const btn = tr.querySelector('button');
    btn.addEventListener('click', ()=>{
      // Modo "scan" usa o BR do LAST_ROW
      if(context === 'scan'){
        if(!LAST_ROW) return;
        const atTarget = pickRepresentativeAT(g.rows);
        const ok = addSelection({ brs: LAST_ROW.brs, at: atTarget, rota: g.cage });
        if(ok){
          showToastCenter({ok:true, title:'Pacote adicionado', subtitle:`${LAST_ROW.brs} ‚Üí ${atTarget}`});
          playAddedSound(); 
          try{navigator.vibrate?.(10);}catch(_){}
          incAddedCount(g.cage);
          /* VOLTAR PARA BARRA DE BIPAGEM AP√ìS STATUS VERDE */
          focusScan();
        }else{
          showToastCenter({ok:false, title:'Duplicado', subtitle:'BR j√° nesta AT'}); 
          playErrorSound();
        }
      }else{
        // Modo Neighborhood / Endere√ßo: abre modal de BR
        NEIGH_PENDING_TARGET = { cage: g.cage, rows: g.rows };
        $("#brInput").value = '';
        $("#brHint").textContent = `Rota: ${g.cage} ‚Ä¢ Bairro: ${bairroShown}`;
        openModal(brModal);
      }
    });
    tbody.appendChild(tr);
  });

  $("#resultRight").style.display = "block";
  $("#placeholderRight").style.display = "none";
}

function renderResult(row, same){
  const sameFiltered = same
    .filter(g => (g.cage||'') !== (row.rota||'')) 
    .filter(g => !VEH_FILTER.size || VEH_FILTER.has((g.rows[0]?.veiculo||'').trim()));

  $("#resultLeft").style.display="block";
  $("#resultRight").style.display="block";
  $("#placeholderRight").style.display="none";

  $("#kBRS").textContent = row.brs || '‚Äî';
  $("#kRota").textContent = row.rota || '‚Äî';
  $("#kBairro").textContent = row.bairro || '‚Äî';
  $("#kVeiculo").textContent = row.veiculo || '‚Äî';
  $("#kAT").textContent = row.at || '‚Äî';

  $("#kEndereco").textContent = row.endereco || '‚Äî';

  fillSameTable(sameFiltered, row.bairro, 'scan');
}

function rerenderSame(){
  if(!LAST_ROW) return;
  renderResult(LAST_ROW, LAST_SAME);
}

/* ========= Sele√ß√µes ========= */
function renderSelections(){
  const tbody = $("#selTable tbody");
  tbody.innerHTML = "";
  SELECTED.forEach((it, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${it.brs||'‚Äî'}</td>
      <td class="mono">${it.at||'‚Äî'}</td>
      <td>${it.rota||'‚Äî'}</td>
      <td><button class="btn small ghost danger" title="Remover">‚úï</button></td>
    `;
    tr.querySelector('button').addEventListener('click', ()=>{
      decAddedCount(it.rota);
      SELECTED.splice(idx,1);
      saveHistory();
      renderSelections();
    });
    tbody.appendChild(tr);
  });
  $("#selInfo").textContent = SELECTED.length ? `${SELECTED.length} item(ns)` : 'Sem itens.';
}
function addSelection({brs, at, rota}){
  const exists = SELECTED.some(it =>
    normBRS(it.brs) === normBRS(brs) &&
    String(it.at||'').trim() === String(at||'').trim()
  );
  if(exists){ return false; }
  SELECTED.push({brs, at, rota});
  saveHistory();
  renderSelections();
  return true;
}
function clearSelections(){
  const perRota = {};
  SELECTED.forEach(it => { perRota[it.rota] = (perRota[it.rota]||0)+1; });
  Object.keys(perRota).forEach(r => decAddedCount(r, perRota[r]));
  SELECTED = [];
  try{ localStorage.removeItem(storageKey()); }catch(_){}
  renderSelections();
}
function exportSelections(){
  if(!SELECTED.length){ showInfo('Exporta√ß√£o', 'Nada para exportar.'); return; }
  const header = ['BR & Protocolo','AT & Protocolo','Rota'];
  const rows = SELECTED.map(it=>[it.brs||'', it.at||'', it.rota||'']);
  const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Realocacoes');
  XLSX.writeFile(wb, `realocacoes_${new Date().toISOString().slice(0,10)}.xlsx`);
}

/* ===== Copiar BR e AT ===== */
async function copySelections(){
  if(!SELECTED.length){
    showToastCenter({ok:false, title:'Nada para copiar', subtitle:'A tabela de realoca√ß√µes est√° vazia.'});
    return;
  }
  const text = SELECTED.map(it => `${(it.brs||'')}\t${(it.at||'')}`).join('\n');
  try{
    await navigator.clipboard.writeText(text);
    showToastCenter({ok:true, title:'Copiado!', subtitle:`${SELECTED.length} linha(s) (BR e AT)`});
    try{ navigator.vibrate?.(12); }catch(_){}
  }catch(_){
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position='fixed'; ta.style.left='-9999px';
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    showToastCenter({ok:ok, title: ok?'Copiado!':'Falha ao copiar', subtitle: ok?`${SELECTED.length} linha(s) (BR e AT)`:'Tente novamente.'});
  }
}

/* ========= Google Sheets ========= */
function parseSpreadsheetId(url){
  const m = String(url).match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  return m ? m[1] : null;
}
async function listTabsFromUrl(){
  const link = $("#sheetUrl").value.trim();
  const select = $("#sheetTab");
  select.innerHTML = '<option value="">Carregando abas‚Ä¶</option>';
  select.disabled = true;
  const spreadsheetId = parseSpreadsheetId(link);
  if(!spreadsheetId){ select.innerHTML = '<option value="">URL inv√°lida</option>'; return; }
  try{
    await ensureAuth();
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if(!res.ok){ select.innerHTML = '<option value="">Falha ao listar abas</option>'; return; }
    const data = await res.json();
    const sheets = (data.sheets||[]).map(s => s.properties?.title).filter(Boolean);
    if(!sheets.length){ select.innerHTML = '<option value="">Sem abas vis√≠veis</option>'; return; }
    select.innerHTML = sheets.map(t => `<option value="${t}">${t}</option>`).join('');
    select.disabled = false;

    try{
      const last = JSON.parse(localStorage.getItem(lastSheetKey())||'null');
      if(last && last.spreadsheetId === spreadsheetId && sheets.includes(last.sheetTitle)){
        select.value = last.sheetTitle;
        $("#startCell").value = last.startCell || 'A1';
      }
    }catch(_){}
  }catch(_){
    select.innerHTML = '<option value="">Erro ao carregar abas</option>';
  }
}
function openSheetsModal(){
  $("#sheetUrl").value = '';
  $("#sheetTab").innerHTML = '<option value="">Cole a URL para listar as abas‚Ä¶</option>';
  $("#sheetTab").disabled = true;
  $("#startCell").value = 'A1';
  try{
    const last = JSON.parse(localStorage.getItem(lastSheetKey())||'null');
    if(last){
      $("#sheetUrl").value = last.url || '';
      if(last.url) listTabsFromUrl();
    }
  }catch(_){}
  openModal(sheetsModal);
}
async function doSendToSheets(){
  if(!SELECTED.length){ showInfo('Envio', 'Nenhuma realoca√ß√£o na tabela.'); return; }
  const link = $("#sheetUrl").value.trim();
  if(!link){ showInfo('URL inv√°lida', 'Cole o link completo da planilha do Google.'); return; }
  const spreadsheetId = parseSpreadsheetId(link);
  if(!spreadsheetId){ showInfo('URL inv√°lida', 'Precisa ser um link de <b>docs.google.com/spreadsheets</b>.'); return; }
  await ensureAuth();
  const sheetTitle = $("#sheetTab").value.trim();
  const startCell  = $("#startCell").value.trim() || 'A1';
  if(!sheetTitle){ showInfo('Aba obrigat√≥ria', 'Selecione a aba de destino.'); return; }
  try{
    localStorage.setItem(lastSheetKey(), JSON.stringify({ url: link, spreadsheetId, sheetTitle, startCell }));
  }catch(_){}
  const range = `${sheetTitle}!${startCell}`;
  const values = SELECTED.map(it=>[it.brs||'', it.at||'']);
  const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
  try{
    const res = await fetch(apiUrl, {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ values })
    });
    if(!res.ok){ const txt = await res.text(); throw new Error(txt); }
    closeModal();
    showToastCenter({ok:true, title:'Enviado!', subtitle:'Dados enviados ao Sheets'});
  }catch(err){
    showToastCenter({ok:false, title:'Falha ao enviar'});
    showInfo('Falha ao enviar', 'Verifique permiss√µes e se a API do Sheets est√° ativa.<br><small>'+ (err?.message||err) +'</small>');
  }
}

/* ========= Ler do Sheets ========= */
const DEFAULT_CTS_TITLE = "Calculation Tasks (CTs)";
async function loadFromGoogleSheet(url, tabTitle = DEFAULT_CTS_TITLE){
  const spreadsheetId = parseSpreadsheetId(url);
  if(!spreadsheetId){
    showInfo('URL inv√°lida', 'Cole um link de <b>docs.google.com/spreadsheets</b>.');
    return;
  }
  await ensureAuth();
  showLoading('Lendo Google Sheets (CTs)‚Ä¶');
  try{
    const range = encodeURIComponent(`'${tabTitle}'!A:ZZZ`);
    const api = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}`;
    const res = await fetch(api, { headers: { Authorization: `Bearer ${accessToken}` } });
    if(!res.ok){
      const msg = await res.text();
      throw new Error(`Falha ao ler a aba "${tabTitle}".<br><small>${msg}</small>`);
    }
    const data = await res.json();
    const values = Array.isArray(data.values) ? data.values : [];
    if(values.length < 2){ throw new Error(`A aba <b>${tabTitle}</b> n√£o tem linhas suficientes (precisa de cabe√ßalho + dados).`); }
    const header = values[0].map(h => String(h||'').trim());
    const rowsObj = values.slice(1).map(row => {
      const o = {};
      for(let i=0;i<header.length;i++){
        const key = header[i] || `Col_${i+1}`;
        o[key] = (row[i] !== undefined && row[i] !== null) ? String(row[i]) : '';
      }
      return o;
    });
    BASE_ROWS = rowsObj.map(normalizeFromExt).filter(r=>r.brs || r.bairro || r.endereco);
    buildIndexes();
    rebuildVehicleFilterFromBase();

    $("#baseInfo").textContent = `${BASE_ROWS.length} linhas carregadas (Google Sheets)`;
    $("#sheetInfo").textContent = `Aba usada: ${tabTitle}`;
    $("#scan").disabled = false; $("#btnScan").disabled = false; $("#btnNeighModal").disabled = false; $("#btnAddrModal").disabled = false;
    $("#scanMsg").innerHTML = '<span class="ok">Base carregada! J√° pode bipar ou pesquisar Neighborhood / Endere√ßo.</span>';

    hideLoading();
    showToastCenter({ok:true, title:'Pacotes prontos', subtitle:'Lidos do Google Sheets (CTs)'});    
    focusScan();

    try{
      localStorage.setItem(LS_LAST_BASE, JSON.stringify({
        name: `Sheets:${spreadsheetId}/${tabTitle}`,
        rows: BASE_ROWS.length,
        when: Date.now()
      }));
    }catch(_){}
  }catch(err){
    hideLoading();
    showToastCenter({ok:false, title:'Falha ao ler do Sheets'});
    showInfo('Falha ao ler do Sheets', err?.message || String(err));
  }
}
async function listTabsFromUrlForImport(){
  const link = $("#importUrl").value.trim();
  const select = $("#importTab");
  select.innerHTML = '<option value="">Carregando abas‚Ä¶</option>'; select.disabled = true;
  const spreadsheetId = parseSpreadsheetId(link);
  if(!spreadsheetId){ select.innerHTML = '<option value="">URL inv√°lida</option>'; return; }
  try{
    await ensureAuth();
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if(!res.ok){ select.innerHTML = '<option value="">Falha ao listar abas</option>'; return; }
    const data = await res.json();
    const sheets = (data.sheets||[]).map(s => s.properties?.title).filter(Boolean);
    if(!sheets.length){ select.innerHTML = '<option value="">Sem abas vis√≠veis</option>'; return; }
    select.innerHTML = sheets.map(t => `<option value="${t}">${t}</option>`).join('');
    select.disabled = false;
    const preferred = sheets.find(t => t.trim().toLowerCase() === DEFAULT_CTS_TITLE.toLowerCase());
    select.value = preferred || sheets[0];
  }catch(_){
    select.innerHTML = '<option value="">Erro ao carregar abas</option>';
  }
}
function openImportModal(){
  $("#importUrl").value = '';
  $("#importTab").innerHTML = '<option value="">Cole a URL para listar as abas‚Ä¶</option>';
  $("#importTab").disabled = true;
  openModal(importModal);
}
async function doImportFromSheets(){
  const url = $("#importUrl").value.trim();
  if(!url){ showInfo('URL inv√°lida', 'Cole a URL do Google Sheets.'); return; }
  const tab = $("#importTab").value || DEFAULT_CTS_TITLE;
  closeModal();
  await loadFromGoogleSheet(url, tab);
}

/* ========= A√ß√µes ========= */
function handleScan(){
  const input = $("#scan");
  const code = input.value.trim();
  if(!code){ showInfo('Busca', 'Digite/escaneie um <b>BRS</b>.'); return; }
  if(!INDEX_BRS.size){ showInfo('Base vazia', 'Carregue a planilha primeiro.'); return; }

  const row = INDEX_BRS.get(normBRS(code));
  if(!row){ showInfo('N√£o encontrado', 'C√≥digo n√£o localizado na base.'); input.value=''; focusScan(); return; }

  const same = findSameNeighborhoodGrouped(row.bairro);
  LAST_ROW = row; LAST_SAME = same;

  renderResult(row, same);
  $("#scanMsg").innerHTML = '<span class="ok">Pesquisa conclu√≠da.</span>';
  input.value=''; focusScan();
}
function resetBase(){
  BASE_ROWS = [];
  INDEX_BRS.clear();
  INDEX_BAIRRO_CLUSTER.clear();
  INDEX_ADDRESS_CLUSTER.clear();
  INDEX_TOTAL_BY_CAGE.clear();
  LAST_ROW=null; LAST_SAME=[];
  NEIGH_SELECTED = new Set();
  ADDR_SELECTED = new Set();
  $("#baseInfo").textContent = 'nenhuma carregada';
  $("#sheetInfo").textContent = '';
  $("#scan").disabled = true; $("#btnScan").disabled = true; $("#btnNeighModal").disabled = true; $("#btnAddrModal").disabled = true;
  $("#scan").value='';
  $("#resultLeft").style.display='none';
  $("#resultRight").style.display='none';
  $("#placeholderRight").style.display='block';
  $("#scanMsg").textContent = 'Carregue a planilha para habilitar a busca.';
  clearSelections();
  clearAddedCounts();
}

/* ========= Neighborhood Modal ========= */
function allNeighborhoodKeys(){
  return Array.from(INDEX_BAIRRO_CLUSTER.keys()).sort((a,b)=> a.localeCompare(b,'pt-BR',{sensitivity:'base'}));
}
function visibleNeighborhoods(filter){
  const t = norm(filter||'');
  const all = allNeighborhoodKeys();
  if(!t) return all;
  return all.filter(k => norm(k).includes(t));
}
function renderNeighList(){
  const list = $("#neighList");
  const filter = $("#neighQuery").value;
  const items = visibleNeighborhoods(filter);
  list.innerHTML = `<div class="list-head">Bairros (${items.length})</div>`;
  if(!items.length){
    list.innerHTML += `<div class="list-item"><em class="muted">Nenhum bairro encontrado</em></div>`;
    return;
  }
  items.forEach(k=>{
    const id = 'n_'+k.replace(/\W+/g,'_');
    const checked = NEIGH_SELECTED.has(k) ? 'checked' : '';
    const row = document.createElement('div');
    row.className = 'list-item';
    row.innerHTML = `<input type="checkbox" id="${id}" ${checked}><label for="${id}" style="flex:1;cursor:pointer">${k}</label>`;
    row.querySelector('input').addEventListener('change', e=>{
      if(e.target.checked) NEIGH_SELECTED.add(k); else NEIGH_SELECTED.delete(k);
      renderNeighChips();
    });
    list.appendChild(row);
  });
}
function renderNeighChips(){
  const wrap = $("#neighChips"); wrap.innerHTML = '';
  Array.from(NEIGH_SELECTED).sort((a,b)=>a.localeCompare(b,'pt-BR')).forEach(k=>{
    const chip = document.createElement('div');
    chip.className = 'chip-x';
    chip.innerHTML = `<span>${k}</span><button title="Remover">√ó</button>`;
    chip.querySelector('button').addEventListener('click', ()=>{
      NEIGH_SELECTED.delete(k);
      renderNeighChips();
      renderNeighList();
    });
    wrap.appendChild(chip);
  });
}
function openNeigh(){
  $("#neighQuery").value = '';
  renderNeighList();
  renderNeighChips();
  openModal(neighModal);
}
function applyNeighSelection(){
  const cages = new Map(); // cage -> {cage, rows, bairro}
  Array.from(NEIGH_SELECTED).forEach(k=>{
    const mapC = INDEX_BAIRRO_CLUSTER.get(k);
    if(!mapC) return;
    for(const [cage, rows] of mapC.entries()){
      if(!VEH_FILTER.size || VEH_FILTER.has((rows[0]?.veiculo||'').trim())){
        const cur = cages.get(cage) || { cage, rows: [], bairro: k };
        cur.rows.push(...rows);
        cages.set(cage, cur);
      }
    }
  });
  const groups = Array.from(cages.values());
  fillSameTable(groups, NEIGH_SELECTED.size === 1 ? Array.from(NEIGH_SELECTED)[0] : '(v√°rios)', 'neigh');
  closeModal();
}

/* ========= Address Modal ========= */
function allAddressKeys(){
  return Array.from(INDEX_ADDRESS_CLUSTER.keys()).sort((a,b)=> a.localeCompare(b,'pt-BR',{sensitivity:'base'}));
}
function visibleAddresses(filter){
  const t = norm(filter||'');
  const all = allAddressKeys();
  if(!t) return all;
  return all.filter(k => norm(k).includes(t));
}
function renderAddrList(){
  const list = $("#addrList");
  const filter = $("#addrQuery").value;
  const keys = visibleAddresses(filter);
  list.innerHTML = `<div class="list-head">Endere√ßos (${keys.length})</div>`;
  if(!keys.length){
    list.innerHTML += `<div class="list-item"><em class="muted">Nenhum endere√ßo encontrado</em></div>`;
    return;
  }
  keys.forEach(k=>{
    const obj = INDEX_ADDRESS_CLUSTER.get(k);
    const labelTxt = obj
      ? `${obj.endereco}${obj.bairro ? ' ‚Äî ' + obj.bairro : ''}`
      : k;
    const id = 'a_'+k.replace(/\W+/g,'_');
    const checked = ADDR_SELECTED.has(k) ? 'checked' : '';
    const row = document.createElement('div');
    row.className = 'list-item';
    row.innerHTML = `<input type="checkbox" id="${id}" ${checked}><label for="${id}" style="flex:1;cursor:pointer">${labelTxt}</label>`;
    row.querySelector('input').addEventListener('change', e=>{
      if(e.target.checked) ADDR_SELECTED.add(k); else ADDR_SELECTED.delete(k);
      renderAddrChips();
    });
    list.appendChild(row);
  });
}
function renderAddrChips(){
  const wrap = $("#addrChips"); wrap.innerHTML = '';
  Array.from(ADDR_SELECTED).sort((a,b)=>a.localeCompare(b,'pt-BR')).forEach(k=>{
    const obj = INDEX_ADDRESS_CLUSTER.get(k);
    const labelTxt = obj
      ? `${obj.endereco}${obj.bairro ? ' ‚Äî ' + obj.bairro : ''}`
      : k;
    const chip = document.createElement('div');
    chip.className = 'chip-x';
    chip.innerHTML = `<span>${labelTxt}</span><button title="Remover">√ó</button>`;
    chip.querySelector('button').addEventListener('click', ()=>{
      ADDR_SELECTED.delete(k);
      renderAddrChips();
      renderAddrList();
    });
    wrap.appendChild(chip);
  });
}
function openAddr(){
  $("#addrQuery").value = '';
  renderAddrList();
  renderAddrChips();
  openModal(addrModal);
}
function applyAddrSelection(){
  const cages = new Map(); // cage -> {cage, rows, bairro}
  Array.from(ADDR_SELECTED).forEach(key=>{
    const obj = INDEX_ADDRESS_CLUSTER.get(key);
    if(!obj) return;
    const mapC = obj.cages;
    for(const [cage, rows] of mapC.entries()){
      if(!VEH_FILTER.size || VEH_FILTER.has((rows[0]?.veiculo||'').trim())){
        const cur = cages.get(cage) || { cage, rows: [], bairro: rows[0]?.bairro || obj.bairro || '' };
        cur.rows.push(...rows);
        cages.set(cage, cur);
      }
    }
  });
  const groups = Array.from(cages.values());
  // labelForGroup usa o endere√ßo quando s√≥ 1, sen√£o "v√°rios endere√ßos"
  let labelForGroup = '(v√°rios endere√ßos)';
  if(ADDR_SELECTED.size === 1){
    const only = Array.from(ADDR_SELECTED)[0];
    const obj = INDEX_ADDRESS_CLUSTER.get(only);
    if(obj) labelForGroup = obj.endereco;
  }
  fillSameTable(groups, labelForGroup, 'addr');
  closeModal();
}

/* ========= Listeners ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  // Splash: mostra s√≥ na 1¬™ visita e some sozinho
  (function maybeShowSplash(){
    const el = document.getElementById('splash');
    if(!el) return;
    const seen = localStorage.getItem(SPLASH_KEY);
    if(seen){ el.remove(); return; }
    setTimeout(()=> el.classList.add('hide'), 1200);
    setTimeout(()=> { el.remove(); localStorage.setItem(SPLASH_KEY,'1'); }, 1600);
  })();

  // Tema inicial (Realocamento Inteligente)
  (function initTheme(){
    let saved = null;
    try{ saved = localStorage.getItem(LS_THEME); }catch(_){}
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initial = saved === 'dark' || saved === 'light' ? saved : (prefersDark ? 'dark' : 'light');
    applyTheme(initial);
    const toggle = document.getElementById('themeToggle');
    if(toggle){
      toggle.addEventListener('click', ()=>{
        const newTheme = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
        applyTheme(newTheme);
      });
    }
  })();

  $("#btnLoad").addEventListener("click", ()=>handleLoad());
  $("#btnScan").addEventListener("click", handleScan);
  $("#scan").addEventListener("keydown", e=>{ if(e.key === "Enter"){ e.preventDefault(); handleScan(); } });
  $("#btnReset").addEventListener("click", resetBase);

  $("#btnExport").addEventListener("click", exportSelections);
  $("#btnClearSel").addEventListener("click", clearSelections);
  $("#btnCopy").addEventListener("click", copySelections);

  // ENVIAR ‚Üí modal e a√ß√µes
  $("#btnSendSheets").addEventListener("click", openSheetsModal);
  $("#sheetUrl").addEventListener("change", listTabsFromUrl);
  $("#sheetUrl").addEventListener("blur", listTabsFromUrl);
  $("#btnDoSend").addEventListener("click", doSendToSheets);

  // IMPORTAR (LER DO SHEETS)
  $("#btnLoadSheets").addEventListener("click", openImportModal);
  $("#importUrl").addEventListener("change", listTabsFromUrlForImport);
  $("#importUrl").addEventListener("blur", listTabsFromUrlForImport);
  $("#btnDoImport").addEventListener("click", doImportFromSheets);

  // Rascunho local at√© logar
  loadHistoryForCurrentUser();
  loadAddedCounts();

  // Info √∫ltima base (cosm√©tico)
  const last = JSON.parse(localStorage.getItem(LS_LAST_BASE) || 'null');
  if (last) {
    const when = new Date(last.when || Date.now()).toLocaleString();
    $("#baseInfo").textContent = `${last.rows} linhas carregadas (√∫ltima: ${last.name} em ${when})`;
  }

  // Neighborhood modal
  $("#btnNeighModal").addEventListener('click', openNeigh);
  $("#neighQuery").addEventListener('input', debounce(renderNeighList, 120));
  $("#btnNeighSelectAll").addEventListener('click', ()=>{
    visibleNeighborhoods($("#neighQuery").value).forEach(k=>NEIGH_SELECTED.add(k));
    renderNeighList(); renderNeighChips();
  });
  $("#btnNeighClear").addEventListener('click', ()=>{
    NEIGH_SELECTED.clear(); renderNeighList(); renderNeighChips();
  });
  $("#btnNeighApply").addEventListener('click', applyNeighSelection);

  // Address modal
  $("#btnAddrModal").addEventListener('click', openAddr);
  $("#addrQuery").addEventListener('input', debounce(renderAddrList, 120));
  $("#btnAddrSelectAll").addEventListener('click', ()=>{
    visibleAddresses($("#addrQuery").value).forEach(k=>ADDR_SELECTED.add(k));
    renderAddrList(); renderAddrChips();
  });
  $("#btnAddrClear").addEventListener('click', ()=>{
    ADDR_SELECTED.clear(); renderAddrList(); renderAddrChips();
  });
  $("#btnAddrApply").addEventListener('click', applyAddrSelection);

  // BR modal confirm (para Neighborhood / Endere√ßo)
  $("#btnBrConfirm").addEventListener('click', ()=>{
    const br = ($("#brInput").value||'').trim();
    if(!br){ showToastCenter({ok:false,title:'BR obrigat√≥rio'}); return; }
    if(!NEIGH_PENDING_TARGET){ closeModal(); return; }
    const atTarget = pickRepresentativeAT(NEIGH_PENDING_TARGET.rows);
    const ok = addSelection({ brs: br, at: atTarget, rota: NEIGH_PENDING_TARGET.cage });
    if(ok){
      showToastCenter({ok:true, title:'Pacote adicionado', subtitle:`${br} ‚Üí ${atTarget}`});
      playAddedSound(); 
      try{navigator.vibrate?.(10);}catch(_){}
      incAddedCount(NEIGH_PENDING_TARGET.cage);
      /* VOLTAR PARA BARRA DE BIPAGEM AP√ìS STATUS VERDE */
      focusScan();
    }else{
      showToastCenter({ok:false, title:'Duplicado', subtitle:'BR j√° nesta AT'}); 
      playErrorSound();
    }
    NEIGH_PENDING_TARGET = null;
    closeModal();
  });
});

/* ========= Drag & Drop ========= */
(function setupDnd(){
  const dz = document.getElementById('dropzone');
  const input = document.getElementById('file');
  const prevent = e=>{e.preventDefault(); e.stopPropagation();};
  ['dragenter','dragover','dragleave','drop'].forEach(ev=> dz.addEventListener(ev, prevent));
  dz.addEventListener('dragenter', ()=> dz.classList.add('dragover'));
  dz.addEventListener('dragover',  ()=> dz.classList.add('dragover'));
  dz.addEventListener('dragleave', ()=> dz.classList.remove('dragover'));
  dz.addEventListener('drop', (e)=>{
    dz.classList.remove('dragover');
    const f = e.dataTransfer?.files?.[0];
    if(f){ input.files = e.dataTransfer.files; handleLoad(f); }
  });
  input.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if(f) handleLoad(f);
  });
})();
</script>
</body>
</html>
